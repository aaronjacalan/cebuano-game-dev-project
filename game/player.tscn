[gd_scene load_steps=5 format=3 uid="uid://o7gchgjqr1i6"]

[ext_resource type="PackedScene" uid="uid://bklxl232veydp" path="res://assets/player/first_person_arm.tscn" id="1_dadds"]

[sub_resource type="GDScript" id="GDScript_sh265"]
script/source = "extends CharacterBody3D

# Movement constants
const SPEED = 7.0
const ACCELERATION = 20.0
const FRICTION = 20.0
const AIR_FRICTION = 2.0

# Camera constants
const MOUSE_SENSITIVITY = 0.0005
const MAX_LOOK_ANGLE = 89.0

# Head bob constants
const BOB_FREQUENCY = 2.0
const BOB_AMPLITUDE = 0.08
const BOB_LERP_SPEED = 10.0

# Node references
@onready var head = $Head
@onready var camera = $Head/Camera3D
@onready var anim_player = $PSX_First_Person_Arms/AnimationPlayer

# Head bob variables
var bob_time = 0.0
var camera_initial_y = 0.0
var idle_ready = false


func _ready() -> void:
	Input.set_mouse_mode(Input.MOUSE_MODE_CAPTURED)
	await get_tree().process_frame
	camera_initial_y = camera.position.y

	# Play the start idle animation first
	anim_player.play(\"Combat_idle_start\")
	anim_player.animation_finished.connect(_on_animation_finished)


func _on_animation_finished(anim_name: String) -> void:
	if anim_name == \"Combat_idle_start\":
		anim_player.play(\"Combat_idle\")
		idle_ready = true


func _input(event: InputEvent) -> void:
	if event is InputEventMouseMotion:
		rotate_y(-event.relative.x * MOUSE_SENSITIVITY)
		var pitch_change = -event.relative.y * MOUSE_SENSITIVITY
		head.rotation.x = clamp(
			head.rotation.x + pitch_change,
			deg_to_rad(-MAX_LOOK_ANGLE),
			deg_to_rad(MAX_LOOK_ANGLE)
		)


func _physics_process(delta: float) -> void:
	if not is_on_floor():
		velocity += get_gravity() * delta

	var input_dir = Input.get_vector(\"move_left\", \"move_right\", \"move_forward\", \"move_backward\")
	var direction = (transform.basis * Vector3(input_dir.x, 0, input_dir.y)).normalized()
	var current_friction = FRICTION if is_on_floor() else AIR_FRICTION

	if direction:
		velocity.x = move_toward(velocity.x, direction.x * SPEED, ACCELERATION * delta)
		velocity.z = move_toward(velocity.z, direction.z * SPEED, ACCELERATION * delta)
	else:
		velocity.x = move_toward(velocity.x, 0, current_friction * delta)
		velocity.z = move_toward(velocity.z, 0, current_friction * delta)

	move_and_slide()
	_apply_head_bob(delta, direction)


func _apply_head_bob(delta: float, direction: Vector3) -> void:
	if camera_initial_y == 0.0 and camera:
		camera_initial_y = camera.position.y

	# Only move the Camera3D node, not the Head or Arms
	if is_on_floor() and direction.length() > 0:
		bob_time += delta * BOB_FREQUENCY
		var bob_offset = sin(bob_time * TAU) * BOB_AMPLITUDE
		var target_y = camera_initial_y + bob_offset
		camera.position.y = lerp(camera.position.y, target_y, BOB_LERP_SPEED * delta)
	else:
		bob_time = 0.0
		camera.position.y = lerp(camera.position.y, camera_initial_y, BOB_LERP_SPEED * delta)
"

[sub_resource type="CapsuleMesh" id="CapsuleMesh_sh265"]
radius = 0.3
height = 2.5

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_dadds"]
points = PackedVector3Array(0.31495512, -0.99171406, 0.15625602, -0.20072375, 1.0710014, 0.2753114, -0.20072375, 1.031482, -0.2800733, 0.19596188, -1.0710014, -0.2800733, -0.20072375, -1.0710014, 0.2753114, 0.15625602, 0.99171406, 0.31495512, -0.319717, 1.031482, -0.1213742, 0.19596188, 1.0710014, -0.2800733, -0.1213742, -1.031482, -0.319717, 0.15625602, -0.99171406, 0.31495512, 0.31495512, 0.99171406, 0.15625602, 0.2753114, -1.0710014, -0.20072375, -0.2800733, -1.0710014, 0.19596188, 0.07365631, 1.217311, 0.11173453, 0.073656335, -1.2173115, 0.11173457, -0.319717, -1.031482, -0.1213742, -0.2800733, 1.0710014, 0.19596188, 0.2753114, 1.0710014, -0.20072375, -0.0782358, -1.2143912, -0.11622269, -0.078235716, 1.2143898, -0.11622256, -0.1213742, 1.031482, -0.319717, -0.2800733, -1.031482, -0.20072375, -0.11632692, -1.2155031, 0.073543385, -0.11632681, 1.2155019, 0.0735433, 0.11162068, -1.2160966, -0.078342326, 0.111619934, 1.2160887, -0.07834183, -0.20072375, -1.031482, -0.2800733, -0.2800733, 1.031482, -0.20072375, 0.18435954, 1.1578844, 0.10965164, 0.18435414, -1.157851, 0.10964841, -0.19056365, -1.1668271, -0.07760685, -0.19056298, 1.1668229, -0.07760658)

[node name="Player" type="CharacterBody3D"]
script = SubResource("GDScript_sh265")

[node name="MeshInstance3D" type="MeshInstance3D" parent="."]
mesh = SubResource("CapsuleMesh_sh265")

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
shape = SubResource("ConvexPolygonShape3D_dadds")

[node name="PSX_First_Person_Arms" parent="." instance=ExtResource("1_dadds")]
transform = Transform3D(-1.3, 0, -1.13649605e-07, 0, 1.3, 0, 1.13649605e-07, 0, -1.3, 0, -1.5, -0.1)

[node name="Head" type="Node3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0)

[node name="Camera3D" type="Camera3D" parent="Head"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.100000024, -0.22131833)
